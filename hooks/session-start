#!/bin/bash
#
# SessionStart Hook: SDD Project Status Detection
#
# This hook runs when a Claude Code session starts and outputs JSON describing:
# 1. Whether project needs SDD permission setup
# 2. Active spec files that can be resumed
#
# Claude reads this JSON and presents interactive options to the user.
#
# Hook behavior:
# - Exits silently if nothing to do
# - Outputs JSON if permissions needed or active specs found
# - No user interaction (Claude handles that)
# - Always non-blocking (exit 0)
#

set -euo pipefail

# Ensure SDD wrapper scripts are in PATH
export PATH="${HOME}/.claude/bin:$PATH"

# Configuration
PROJECT_ROOT=$(pwd)
SETTINGS_FILE="${HOME}/.claude/settings.json"
SPECS_ACTIVE_DIR="${PROJECT_ROOT}/specs/active"
MARKER_DIR="/tmp"
MARKER_PREFIX=".claude-sdd-begin"

# =============================================================================
# CONFIGURATION LOADING
# =============================================================================

is_auto_offer_enabled() {
    if [ ! -f "$SETTINGS_FILE" ]; then
        echo "true"
        return
    fi

    python3 -c "
import json
try:
    with open('$SETTINGS_FILE', 'r') as f:
        settings = json.load(f)
    enabled = settings.get('sdd', {}).get('auto_offer_permissions', True)
    print('true' if enabled else 'false')
except:
    print('true')
" 2>/dev/null || echo "true"
}

# =============================================================================
# VERSION CHECKING
# =============================================================================

check_version_mismatch() {
    python3 <<'EOF'
import json
import re
import sys

try:
    # Get installed package version
    try:
        from importlib.metadata import version
        installed_version = version('claude-skills')
    except Exception:
        # Package not installed - skip check
        sys.exit(0)

    # Get plugin version from pyproject.toml
    import os
    plugin_root = os.environ.get('CLAUDE_PLUGIN_ROOT', '')
    if not plugin_root:
        sys.exit(0)

    pyproject_path = f"{plugin_root}/src/claude_skills/pyproject.toml"

    try:
        with open(pyproject_path, 'r') as f:
            content = f.read()
            match = re.search(r'version\s*=\s*"([^"]+)"', content)
            plugin_version = match.group(1) if match else None
    except Exception:
        # Can't read plugin version - skip check
        sys.exit(0)

    # Compare versions
    if installed_version != plugin_version:
        result = {
            "mismatch": True,
            "installed": installed_version,
            "plugin": plugin_version
        }
        print(json.dumps(result))
    else:
        print(json.dumps({"mismatch": False}))

except Exception as e:
    # On any error, silently skip check
    print(json.dumps({"mismatch": False, "error": str(e)}))
EOF
}

# =============================================================================
# PERMISSION CHECKING
# =============================================================================

needs_permission_setup() {
    # Check if user previously declined (using local marker file)
    local declined_marker="${HOME}/.claude/.sdd-permissions-declined"
    if [ -f "$declined_marker" ]; then
        if grep -q "^$PROJECT_ROOT$" "$declined_marker" 2>/dev/null; then
            echo "false"
            return
        fi
    fi

    # Check if project needs setup
    local check_result=$(sdd skills-dev setup-permissions check "$PROJECT_ROOT" 2>/dev/null)
    local needs_setup=$(echo "$check_result" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    configured = data.get('configured', False)
    print('false' if configured else 'true')
except:
    print('false')
" 2>/dev/null)

    echo "$needs_setup"
}

# =============================================================================
# ACTIVE SPEC DETECTION
# =============================================================================

get_active_specs_json() {
    # Check if specs/active directory exists
    if [ ! -d "$SPECS_ACTIVE_DIR" ]; then
        echo "[]"
        return
    fi

    # Find all markdown files and build JSON array
    python3 <<EOF
import os
import json
import re

specs = []
spec_dir = "$SPECS_ACTIVE_DIR"

if os.path.exists(spec_dir):
    for filename in os.listdir(spec_dir):
        if filename.endswith('.md'):
            spec_file = os.path.join(spec_dir, filename)
            spec_id = filename[:-3]  # Remove .md extension

            # Try to determine status
            status = "unknown"
            try:
                with open(spec_file, 'r') as f:
                    content = f.read()
                    if re.search(r'status:\s*(?:in[-_\s]progress|pending)', content, re.IGNORECASE):
                        status = "has pending/in-progress tasks"
                    elif re.search(r'status:\s*completed', content, re.IGNORECASE):
                        status = "all tasks completed"
            except:
                pass

            specs.append({
                "spec_id": spec_id,
                "file": spec_file,
                "status": status
            })

print(json.dumps(specs))
EOF
}

# =============================================================================
# MARKER FILE MANAGEMENT
# =============================================================================

cleanup_old_markers() {
    # Remove marker files older than 1 hour
    find "$MARKER_DIR" -name "${MARKER_PREFIX}-*.json" -type f -mmin +60 -delete 2>/dev/null || true
}

create_marker_file() {
    local needs_perms=$1
    local active_specs_json=$2
    local system_msg=$3

    # Generate timestamp for unique filename
    local timestamp=$(date +%s)
    local marker_file="${MARKER_DIR}/${MARKER_PREFIX}-${timestamp}.json"

    # Convert bash true/false to Python True/False
    local py_bool="False"
    if [ "$needs_perms" = "true" ]; then
        py_bool="True"
    fi

    # Create marker file with JSON data using proper escaping
    python3 -c "
import json
import sys

marker = {
    'project_root': '''$PROJECT_ROOT''',
    'needs_permissions': $py_bool,
    'active_specs': $active_specs_json,
    'message': '''$system_msg''',
    'timestamp': $timestamp
}

print(json.dumps(marker, indent=2))
" > "$marker_file"
}

# =============================================================================
# MAIN LOGIC
# =============================================================================

main() {
    # Output session marker for transcript identification
    # This helps the context tracker identify the current session's transcript
    # by searching for this marker pattern in transcript files
    # Using 4 bytes = 8 hex chars for easier reproduction
    echo "SESSION_MARKER_$(openssl rand -hex 4 2>/dev/null || echo '0')" 2>/dev/null || true

    # Clean up old marker files
    cleanup_old_markers

    # Check for version mismatch (always check, regardless of auto-offer setting)
    local version_check_result=$(check_version_mismatch 2>/dev/null || echo '{"mismatch":false}')
    local version_mismatch=$(echo "$version_check_result" | python3 -c "import json, sys; data = json.load(sys.stdin); print('true' if data.get('mismatch', False) else 'false')" 2>/dev/null || echo "false")

    # If version mismatch, show warning and exit (this takes priority)
    if [ "$version_mismatch" = "true" ]; then
        local installed_ver=$(echo "$version_check_result" | python3 -c "import json, sys; print(json.load(sys.stdin).get('installed', 'unknown'))" 2>/dev/null || echo "unknown")
        local plugin_ver=$(echo "$version_check_result" | python3 -c "import json, sys; print(json.load(sys.stdin).get('plugin', 'unknown'))" 2>/dev/null || echo "unknown")

        # Output JSON for Claude to read
        cat <<EOF
{
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": "Plugin version $plugin_ver detected, but installed Python package is $installed_ver"
  },
  "systemMessage": "âš ï¸  Plugin updated to v$plugin_ver but Python package is v$installed_ver. Reinstall: cd ~/.claude/plugins/marketplaces/claude-sdd-toolkit/src/claude_skills && pip install -e ."
}
EOF
        exit 0
    fi

    # Check if auto-offer is enabled
    if [ "$(is_auto_offer_enabled)" != "true" ]; then
        exit 0
    fi

    # FIRST: Check if this is an SDD project (has specs/active folder)
    if [ ! -d "$SPECS_ACTIVE_DIR" ]; then
        exit 0
    fi

    # Detect what's needed
    local needs_perms=$(needs_permission_setup)

    local active_specs_json=$(get_active_specs_json)
    local has_specs=$(echo "$active_specs_json" | python3 -c "import json, sys; print('true' if len(json.load(sys.stdin)) > 0 else 'false')")

    # If nothing to do, exit silently
    if [ "$needs_perms" != "true" ] && [ "$has_specs" != "true" ]; then
        exit 0
    fi

    # Build system message for user (visible in CLI)
    local system_msg=""

    if [ "$needs_perms" = "true" ]; then
        system_msg="ðŸ“‹ This project needs SDD permission setup. Run /sdd-begin to configure."
    fi

    if [ "$has_specs" = "true" ]; then
        # Add spec information to system message
        local spec_list=$(echo "$active_specs_json" | python3 -c "
import json, sys
specs = json.load(sys.stdin)
if specs:
    result = 'ðŸ“ Active specs: ' + ', '.join([spec['spec_id'] for spec in specs])
    print(result)
" 2>/dev/null || echo "")

        if [ -n "$spec_list" ]; then
            if [ -n "$system_msg" ]; then
                system_msg="$system_msg | $spec_list"
            else
                system_msg="$spec_list. Run /sdd-begin to resume work."
            fi
        fi
    fi

    # Build additional context for Claude (not visible to user, but Claude can read it)
    local additional_context=""
    if [ "$needs_perms" = "true" ]; then
        additional_context="SDD project detected at $PROJECT_ROOT. Permissions not yet configured."
    fi
    if [ "$has_specs" = "true" ]; then
        local spec_details=$(echo "$active_specs_json" | python3 -c "
import json, sys
specs = json.load(sys.stdin)
if specs:
    details = ' Active specifications: '
    details += ', '.join([f\"{s['spec_id']} ({s['status']})\" for s in specs])
    print(details)
" 2>/dev/null || echo "")

        if [ -n "$additional_context" ]; then
            additional_context="$additional_context$spec_details"
        else
            additional_context="SDD project at $PROJECT_ROOT.$spec_details"
        fi
    fi

    # Convert bash booleans to Python format for marker file
    local py_needs_perms="false"
    if [ "$needs_perms" = "true" ]; then
        py_needs_perms="true"
    fi

    # Create marker file for Claude to read proactively
    create_marker_file "$py_needs_perms" "$active_specs_json" "$system_msg"

    # Also output JSON in the format Claude Code expects (for system message display)
    python3 <<EOF
import json

output = {
    "hookSpecificOutput": {
        "hookEventName": "SessionStart",
        "additionalContext": "$additional_context"
    }
}

# Only add systemMessage if we have one (it will be shown to user)
if "$system_msg":
    output["systemMessage"] = "$system_msg"

print(json.dumps(output, indent=2))
EOF

    exit 0
}

# Run main
main
