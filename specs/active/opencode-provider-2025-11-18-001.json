{
  "spec_id": "opencode-provider-2025-11-18-001",
  "generated": "2025-11-18T21:52:00Z",
  "last_updated": "2025-11-19T12:29:51.584146Z",
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "Add OpenCode as Provider",
      "status": "in_progress",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3",
        "phase-4",
        "phase-5",
        "task-2-1-7"
      ],
      "total_tasks": 41,
      "completed_tasks": 1,
      "metadata": {
        "description": "Integrate OpenCode as a new AI provider using Node.js SDK wrapper approach with Python subprocess management",
        "objectives": [
          "Create Node.js wrapper using OpenCode SDK for session and prompt management",
          "Implement Python provider following existing patterns (Gemini/Codex)",
          "Integrate with provider registry and detection system",
          "Support model selection, tool restrictions, and token tracking",
          "Add comprehensive testing and verification"
        ]
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "Node.js SDK Wrapper Implementation",
      "status": "in_progress",
      "parent": "spec-root",
      "children": [
        "phase-1-files",
        "phase-1-verify",
        "task-1-5"
      ],
      "total_tasks": 13,
      "completed_tasks": 1,
      "metadata": {
        "purpose": "Create Node.js wrapper script that uses OpenCode SDK to handle server management, sessions, and prompts",
        "risk_level": "medium"
      },
      "dependencies": {
        "blocks": [
          "phase-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-1-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "in_progress",
      "parent": "phase-1",
      "children": [
        "task-1-1",
        "task-1-2",
        "task-1-3",
        "task-1-4"
      ],
      "total_tasks": 8,
      "completed_tasks": 1,
      "metadata": {},
      "dependencies": {
        "blocks": [
          "phase-1-verify"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "src/claude_skills/claude_skills/common/providers/opencode_wrapper.js",
      "status": "pending",
      "parent": "phase-1-files",
      "children": [
        "task-1-1-1",
        "task-1-1-2",
        "task-1-1-3",
        "task-1-1-4"
      ],
      "dependencies": {
        "blocks": [
          "task-1-2",
          "task-1-5"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "src/claude_skills/claude_skills/common/providers/opencode_wrapper.js",
        "task_category": "implementation",
        "estimated_hours": 4,
        "description": "Node.js wrapper script using OpenCode SDK for provider integration"
      }
    },
    "task-1-1-1": {
      "type": "subtask",
      "title": "Import OpenCode SDK and setup argument parsing",
      "status": "pending",
      "parent": "task-1-1",
      "children": [
        "verify-1-1-1-2"
      ],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Import @opencode-ai/sdk, setup CLI argument parsing (prompt, model, tools, system prompt, working directory) CRITICAL DESIGN: Use stdin for data transmission to avoid CLI argument length limits. Only use CLI args for simple flags like --version."
      },
      "dependencies": {
        "blocks": [
          "task-1-1-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "description": "Define CLI interface for the wrapper script. The wrapper accepts minimal CLI flags (e.g., --version, --help) but receives all prompt data via stdin. On execution, the wrapper reads a JSON payload from stdin containing: {\"prompt\": \"...\", \"system_prompt\": \"...\", \"config\": {...}, \"allowedTools\": [...]}. This avoids OS argument length limits (~128KB) that would cause failures on large prompts or complex tool definitions."
    },
    "task-1-1-2": {
      "type": "subtask",
      "title": "Implement client connection",
      "status": "pending",
      "parent": "task-1-1",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "task-1-1-1"
        ],
        "blocks": [
          "task-1-1-3"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Use createOpencodeClient() to connect to the server URL provided in config/env. Do NOT start a server instance here. Add SIGINT/SIGTERM handlers."
      },
      "description": "Implement OpenCode Client initialization. Use 'createOpencodeClient()' to connect to the existing OpenCode server (managed by the Python provider). Read OPENCODE_SERVER_URL from environment (defaulting to localhost:4096). Implement signal handlers to cleanly disconnect."
    },
    "task-1-1-3": {
      "type": "subtask",
      "title": "Create session and execute prompt with model and tool restrictions",
      "status": "pending",
      "parent": "task-1-1",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "task-1-1-2"
        ],
        "blocks": [
          "task-1-1-4"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Create a new session using client.session.create(). Use the session ID to call session.prompt() with model selection. Construct model object { providerID, modelID } by parsing input."
      },
      "description": "Parse configuration from stdin JSON payload. Create a new ephemeral session via 'client.session.create()'. Construct the model object required by SDK: {providerID: '...', modelID: '...'} by parsing the 'model' string. Call 'client.session.prompt()' using the new session ID. Investigate SDK support for tool restrictions; if unsupported, document limitation or attempt to enforce via system prompt instructions."
    },
    "task-1-1-4": {
      "type": "subtask",
      "title": "Format and output JSON response",
      "status": "pending",
      "parent": "task-1-1",
      "children": [
        "verify-1-1-4-1",
        "verify-1-1-4-2"
      ],
      "dependencies": {
        "blocked_by": [
          "task-1-1-3"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Implement streaming using client.event.subscribe(). Listen for events (e.g. message.delta) to emit chunks {type: 'chunk', content: '...'} to stdout. Handle final response from prompt() result for usage stats. CRITICAL: Top-level try/catch."
      },
      "description": "Implement streaming response handling using 'client.event.subscribe()' to capture real-time token events. Emit line-delimited JSON chunks: {\"type\": \"chunk\", \"content\": \"token\"} as events arrive. On completion (from prompt() return value), output {\"type\": \"done\", \"response\": {...}}. Wrap ALL execution in a top-level try/catch block to output structured JSON errors on failure."
    },
    "task-1-2": {
      "type": "task",
      "title": "src/claude_skills/claude_skills/common/providers/package.json",
      "status": "completed",
      "parent": "phase-1-files",
      "children": [
        "task-1-2-1"
      ],
      "dependencies": {
        "blocked_by": [
          "task-1-1"
        ],
        "blocks": [
          "task-1-4"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "file_path": "src/claude_skills/claude_skills/common/providers/package.json",
        "task_category": "implementation",
        "estimated_hours": 0.5,
        "description": "Add package.json for Node.js dependencies"
      }
    },
    "task-1-2-1": {
      "type": "subtask",
      "title": "Create package.json with OpenCode SDK dependency",
      "status": "completed",
      "parent": "task-1-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "description": "Add @opencode-ai/sdk dependency, set type: module for ES6 imports IMPORTANT: Pin SDK to specific version (e.g., ^1.0.0) to prevent future breakage. Don't use 'latest'.",
        "started_at": "2025-11-19T12:28:28.753881Z",
        "status_note": "Creating package.json with pinned SDK version",
        "completed_at": "2025-11-19T12:29:51.573208Z",
        "needs_journaling": false,
        "actual_hours": 0.023,
        "journaled_at": "2025-11-19T12:29:51.580900Z"
      },
      "description": "Create package.json with pinned SDK version. Initialize package.json with @opencode-ai/sdk pinned to a specific version (e.g., \"^1.0.0\" or specific beta tag like \"1.0.0-beta.5\"). Pinning prevents breakage from future SDK updates. Include other necessary fields: name, version, description, main entry point."
    },
    "task-1-3": {
      "type": "task",
      "title": "src/claude_skills/claude_skills/common/providers/.gitignore",
      "status": "pending",
      "parent": "phase-1-files",
      "children": [
        "task-1-3-1"
      ],
      "dependencies": {
        "blocked_by": [],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "src/claude_skills/claude_skills/common/providers/.gitignore",
        "task_category": "implementation",
        "estimated_hours": 0.25,
        "description": "Add .gitignore for Node.js artifacts"
      }
    },
    "task-1-3-1": {
      "type": "subtask",
      "title": "Add Node.js gitignore entries",
      "status": "pending",
      "parent": "task-1-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Ignore node_modules/, package-lock.json if present"
      }
    },
    "task-1-4": {
      "type": "task",
      "title": "Install OpenCode SDK dependencies",
      "status": "pending",
      "parent": "phase-1-files",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "task-1-2"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 0.5,
        "description": "Run npm install in providers directory to install @opencode-ai/sdk",
        "file_path": "task-1-4.md"
      }
    },
    "phase-1-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-1",
      "children": [
        "verify-1-1",
        "verify-1-2",
        "verify-1-3",
        "verify-1-4"
      ],
      "dependencies": {
        "blocked_by": [
          "phase-1-files"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Wrapper script syntax is valid",
      "status": "pending",
      "parent": "phase-1-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "command": "node --check src/claude_skills/claude_skills/common/providers/opencode_wrapper.js",
        "expected": "No syntax errors"
      },
      "dependencies": {
        "blocks": [
          "verify-1-3",
          "verify-1-4"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-1-2": {
      "type": "verify",
      "title": "SDK dependencies installed",
      "status": "pending",
      "parent": "phase-1-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "command": "npm list @opencode-ai/sdk --prefix src/claude_skills/claude_skills/common/providers",
        "expected": "@opencode-ai/sdk present in node_modules"
      },
      "dependencies": {
        "blocks": [
          "verify-1-3",
          "verify-1-4"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-1-3": {
      "type": "verify",
      "title": "Wrapper executes and returns valid JSON",
      "status": "pending",
      "parent": "phase-1-verify",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "verify-1-1",
          "verify-1-2"
        ],
        "blocks": [
          "verify-1-4"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "command": "node src/claude_skills/claude_skills/common/providers/opencode_wrapper.js --prompt 'test' | python3 -m json.tool",
        "expected": "Valid JSON response with text, tokens, and model fields"
      }
    },
    "verify-1-4": {
      "type": "verify",
      "title": "Phase 1 implementation fidelity review",
      "status": "pending",
      "parent": "phase-1-verify",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "verify-1-1",
          "verify-1-2",
          "verify-1-3"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "fidelity",
        "skill": "sdd-fidelity-review",
        "scope": "phase",
        "target": "phase-1",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "agent": "sdd-fidelity-review"
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Python Provider Implementation",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "phase-2-files",
        "phase-2-verify",
        "task-2-3"
      ],
      "dependencies": {
        "blocked_by": [
          "phase-1"
        ],
        "blocks": [
          "phase-3"
        ],
        "depends": []
      },
      "total_tasks": 8,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Create Python provider that manages Node.js wrapper subprocess and handles responses",
        "risk_level": "medium"
      }
    },
    "phase-2-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "pending",
      "parent": "phase-2",
      "children": [
        "task-2-1"
      ],
      "total_tasks": 6,
      "completed_tasks": 0,
      "metadata": {},
      "dependencies": {
        "blocks": [
          "phase-2-verify"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "src/claude_skills/claude_skills/common/providers/opencode.py",
      "status": "pending",
      "parent": "phase-2-files",
      "children": [
        "task-2-1-1",
        "task-2-1-2",
        "task-2-1-3",
        "task-2-1-4",
        "task-2-1-5",
        "task-2-1-6"
      ],
      "total_tasks": 6,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "src/claude_skills/claude_skills/common/providers/opencode.py",
        "task_category": "implementation",
        "estimated_hours": 5,
        "description": "Main Python provider following Gemini/Codex patterns"
      },
      "dependencies": {
        "blocks": [
          "task-2-3"
        ],
        "blocked_by": [
          "task-1-5"
        ],
        "depends": []
      }
    },
    "task-2-1-1": {
      "type": "subtask",
      "title": "Add constants and imports",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Add DEFAULT_BINARY=node, DEFAULT_WRAPPER_SCRIPT path, DEFAULT_TIMEOUT_SECONDS=360, DEFAULT_SERVER_URL='http://localhost:4096', SERVER_STARTUP_TIMEOUT=30. Import subprocess, time, socket, etc."
      },
      "dependencies": {
        "blocks": [
          "task-2-1-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-1-2": {
      "type": "subtask",
      "title": "Define model descriptors and metadata",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "task-2-1-1"
        ],
        "blocks": [
          "task-2-1-3"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Create OPENCODE_MODELS list with ModelDescriptor entries (user-configurable via ai_config.yaml), OPENCODE_METADATA with provider_name, security_flags (writes_allowed: False)"
      }
    },
    "task-2-1-3": {
      "type": "subtask",
      "title": "Implement OpenCodeProvider class",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "task-2-1-2"
        ],
        "blocks": [
          "task-2-1-4",
          "task-2-1-7"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Create class extending ProviderContext. Add `_server_process` attribute. Initialize with binary, wrapper path, runner, env, timeout."
      }
    },
    "task-2-1-4": {
      "type": "subtask",
      "title": "Implement _execute method",
      "status": "pending",
      "parent": "task-2-1",
      "children": [
        "verify-2-1-4-1"
      ],
      "dependencies": {
        "blocked_by": [
          "task-2-1-3",
          "task-2-1-7"
        ],
        "blocks": [
          "task-2-1-5"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Call _ensure_server_running(). Build command calling wrapper script, run subprocess, parse JSON response, extract token usage, emit streaming chunks, return GenerationResult."
      },
      "description": "Implement the _execute method. 1. Call `self._ensure_server_running()` to verify server availability. 2. Build subprocess command. 3. Write JSON payload to stdin. 4. Stream JSON chunks from stdout. 5. Handle done/error messages. 6. Return GenerationResult."
    },
    "task-2-1-5": {
      "type": "subtask",
      "title": "Add factory function and availability check",
      "status": "pending",
      "parent": "task-2-1",
      "children": [
        "verify-2-1-5-1"
      ],
      "dependencies": {
        "blocked_by": [
          "task-2-1-4"
        ],
        "blocks": [
          "task-2-1-6"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Create create_provider() factory. Implement is_opencode_available() checking for node runtime AND opencode binary (in node_modules or PATH). Check for node_modules presence."
      },
      "description": "Implement is_opencode_available() with comprehensive dependency checks. Check: (1) Node.js runtime available. (2) Wrapper script exists. (3) node_modules exists with @opencode-ai/sdk. (4) `opencode` binary exists (in node_modules/.bin/opencode or global PATH) for server management. If missing, raise ProviderUnavailableError with setup instructions."
    },
    "task-2-1-7": {
      "type": "subtask",
      "title": "Implement server lifecycle management",
      "status": "pending",
      "parent": "spec-root",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "task-2-1-3"
        ],
        "blocks": [
          "task-2-1-4"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Implement _ensure_server_running() to check if opencode server is active on port. If not, spawn 'opencode serve' (via node_modules/.bin/opencode) in background. Wait for health check."
      },
      "description": "Implement helper method `_ensure_server_running()`. 1. Check if TCP port 4096 (or configured port) is open using socket connection. 2. If closed, locate `opencode` binary (prefer local node_modules/.bin/opencode, fall back to global). 3. Spawn `opencode serve` as a detached background process. 4. Loop/wait (up to SERVER_STARTUP_TIMEOUT) for port to become active. 5. Store process handle (if possible) or rely on persistent OS process."
    },
    "task-2-1-6": {
      "type": "subtask",
      "title": "Register provider",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "task-2-1-5"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Call register_provider() with opencode id, factory, metadata, availability_check, description, tags=(sdk, text, vision), replace=True"
      }
    },
    "phase-2-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-2",
      "children": [
        "verify-2-1"
      ],
      "dependencies": {
        "blocked_by": [
          "phase-2-files"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Phase 2 implementation fidelity review",
      "status": "pending",
      "parent": "phase-2-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "fidelity",
        "skill": "sdd-fidelity-review",
        "scope": "phase",
        "target": "phase-2",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "agent": "sdd-fidelity-review"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "System Integration",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "phase-3-files",
        "phase-3-verify"
      ],
      "dependencies": {
        "blocked_by": [
          "phase-2"
        ],
        "blocks": [
          "phase-4"
        ],
        "depends": []
      },
      "total_tasks": 8,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Integrate OpenCode provider with existing registry, detection, and configuration systems",
        "risk_level": "low"
      }
    },
    "phase-3-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "pending",
      "parent": "phase-3",
      "children": [
        "task-3-1",
        "task-3-2",
        "task-3-3",
        "task-3-4",
        "task-3-5"
      ],
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {},
      "dependencies": {
        "blocks": [
          "phase-3-verify"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "src/claude_skills/claude_skills/common/providers/__init__.py",
      "status": "pending",
      "parent": "phase-3-files",
      "children": [
        "task-3-1-1"
      ],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "src/claude_skills/claude_skills/common/providers/__init__.py",
        "task_category": "implementation",
        "estimated_hours": 0.5,
        "description": "Add OpenCode imports and exports"
      }
    },
    "task-3-1-1": {
      "type": "subtask",
      "title": "Import and export OpenCode provider",
      "status": "pending",
      "parent": "task-3-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Add from .opencode import OpenCodeProvider, create_provider as create_opencode_provider, is_opencode_available as opencode_is_available, OPENCODE_METADATA to imports and __all__"
      }
    },
    "task-3-2": {
      "type": "task",
      "title": "src/claude_skills/claude_skills/common/providers/detectors.py",
      "status": "pending",
      "parent": "phase-3-files",
      "children": [
        "task-3-2-1"
      ],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "src/claude_skills/claude_skills/common/providers/detectors.py",
        "task_category": "implementation",
        "estimated_hours": 0.5,
        "description": "Add OpenCode detector to registry"
      }
    },
    "task-3-2-1": {
      "type": "subtask",
      "title": "Add OpenCode ProviderDetector",
      "status": "pending",
      "parent": "task-3-2",
      "children": [
        "verify-3-2-1-1"
      ],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Add ProviderDetector to _DEFAULT_DETECTORS. Check for 'node' runtime AND 'opencode' command capability (via npm exec or local bin)."
      },
      "description": "Update ProviderDetector. It should verify Node.js runtime is available. Additionally, since we manage the server process, it should hint if 'opencode' command is likely available (e.g. by checking if node_modules is hydrated or global 'opencode' exists).",
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-3": {
      "type": "task",
      "title": "src/claude_skills/claude_skills/common/ai_config.py",
      "status": "pending",
      "parent": "phase-3-files",
      "children": [
        "task-3-3-1"
      ],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "src/claude_skills/claude_skills/common/ai_config.py",
        "task_category": "implementation",
        "estimated_hours": 1,
        "description": "Add OpenCode to default tools and models configuration"
      }
    },
    "task-3-3-1": {
      "type": "subtask",
      "title": "Update DEFAULT_TOOLS and DEFAULT_MODELS",
      "status": "pending",
      "parent": "task-3-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Add opencode to DEFAULT_TOOLS with description, command, enabled=True. Add opencode to DEFAULT_MODELS with priority list (user-configurable). Add opencode to DEFAULT_CONSENSUS_AGENTS list"
      }
    },
    "task-3-4": {
      "type": "task",
      "title": "src/claude_skills/claude_skills/common/ai_tools.py",
      "status": "pending",
      "parent": "phase-3-files",
      "children": [
        "task-3-4-1"
      ],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "src/claude_skills/claude_skills/common/ai_tools.py",
        "task_category": "implementation",
        "estimated_hours": 0.5,
        "description": "Add OpenCode command building to build_tool_command()"
      }
    },
    "task-3-4-1": {
      "type": "subtask",
      "title": "Add opencode case to build_tool_command",
      "status": "pending",
      "parent": "task-3-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Add elif tool == 'opencode' case building command with wrapper script path, --prompt, --model (if specified)"
      }
    },
    "task-3-5": {
      "type": "task",
      "title": ".claude/ai_config.yaml",
      "status": "pending",
      "parent": "phase-3-files",
      "children": [
        "task-3-5-1"
      ],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "file_path": ".claude/ai_config.yaml",
        "task_category": "implementation",
        "estimated_hours": 0.5,
        "description": "Add OpenCode to user configuration template"
      }
    },
    "task-3-5-1": {
      "type": "subtask",
      "title": "Update ai_config.yaml template",
      "status": "pending",
      "parent": "task-3-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Add opencode to tools section with enabled, command. Add opencode model priorities. Add to tool_priority lists. Add to consensus agents"
      }
    },
    "phase-3-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-3",
      "children": [
        "verify-3-1",
        "verify-3-2",
        "verify-3-3"
      ],
      "dependencies": {
        "blocked_by": [
          "phase-3-files"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 3,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Provider registry includes OpenCode",
      "status": "pending",
      "parent": "phase-3-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "command": "python3 -c \"from claude_skills.common.providers.registry import available_providers; print('opencode' in available_providers())\"",
        "expected": "True"
      },
      "dependencies": {
        "blocks": [
          "verify-3-3"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-3-2": {
      "type": "verify",
      "title": "OpenCode detector registered",
      "status": "pending",
      "parent": "phase-3-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "command": "python3 -c \"from claude_skills.common.providers.detectors import _DEFAULT_DETECTORS; print(any(d.provider_id == 'opencode' for d in _DEFAULT_DETECTORS))\"",
        "expected": "True"
      },
      "dependencies": {
        "blocks": [
          "verify-3-3"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-3-3": {
      "type": "verify",
      "title": "Phase 3 implementation fidelity review",
      "status": "pending",
      "parent": "phase-3-verify",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "verify-3-1",
          "verify-3-2"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "fidelity",
        "skill": "sdd-fidelity-review",
        "scope": "phase",
        "target": "phase-3",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "agent": "sdd-fidelity-review"
      }
    },
    "phase-4": {
      "type": "phase",
      "title": "Testing",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "phase-4-files",
        "phase-4-verify"
      ],
      "dependencies": {
        "blocked_by": [
          "phase-3"
        ],
        "blocks": [
          "phase-5"
        ],
        "depends": []
      },
      "total_tasks": 6,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Create comprehensive unit and integration tests for OpenCode provider",
        "risk_level": "low"
      }
    },
    "phase-4-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "pending",
      "parent": "phase-4",
      "children": [
        "task-4-1"
      ],
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {},
      "dependencies": {
        "blocks": [
          "phase-4-verify"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-1": {
      "type": "task",
      "title": "src/claude_skills/claude_skills/tests/unit/test_providers/test_opencode_provider.py",
      "status": "pending",
      "parent": "phase-4-files",
      "children": [
        "task-4-1-1",
        "task-4-1-2",
        "task-4-1-3",
        "task-4-1-4"
      ],
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "src/claude_skills/claude_skills/tests/unit/test_providers/test_opencode_provider.py",
        "task_category": "implementation",
        "estimated_hours": 4,
        "description": "Comprehensive unit tests following test_gemini_provider.py pattern"
      },
      "dependencies": {
        "blocks": [
          "task-5-1"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-1-1": {
      "type": "subtask",
      "title": "Test command construction",
      "status": "pending",
      "parent": "task-4-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Test _build_command with various options (prompt, model, tools, system prompt, working directory)"
      }
    },
    "task-4-1-2": {
      "type": "subtask",
      "title": "Test JSON parsing and token extraction",
      "status": "pending",
      "parent": "task-4-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Mock subprocess responses, verify JSON parsing, token usage extraction, response text extraction from parts array"
      }
    },
    "task-4-1-3": {
      "type": "subtask",
      "title": "Test error handling",
      "status": "pending",
      "parent": "task-4-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Test ProviderUnavailableError (binary not found), ProviderTimeoutError (timeout), ProviderExecutionError (non-zero exit, invalid JSON)"
      }
    },
    "task-4-1-4": {
      "type": "subtask",
      "title": "Test provider hooks and model validation",
      "status": "pending",
      "parent": "task-4-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "description": "Test before_execute, after_result, on_stream_chunk hooks. Test model descriptor validation"
      }
    },
    "phase-4-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-4",
      "children": [
        "verify-4-1",
        "verify-4-2"
      ],
      "dependencies": {
        "blocked_by": [
          "phase-4-files"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-4-1": {
      "type": "verify",
      "title": "Unit tests pass",
      "status": "pending",
      "parent": "phase-4-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "agent": "run-tests",
        "command": "pytest src/claude_skills/claude_skills/tests/unit/test_providers/test_opencode_provider.py -v",
        "expected": "All tests pass"
      },
      "dependencies": {
        "blocks": [
          "verify-4-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-4-2": {
      "type": "verify",
      "title": "Phase 4 implementation fidelity review",
      "status": "pending",
      "parent": "phase-4-verify",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "verify-4-1"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "fidelity",
        "skill": "sdd-fidelity-review",
        "scope": "phase",
        "target": "phase-4",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "agent": "sdd-fidelity-review"
      }
    },
    "phase-5": {
      "type": "phase",
      "title": "Integration Testing & Documentation",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "phase-5-files",
        "phase-5-verify",
        "task-5-1",
        "task-5-2"
      ],
      "dependencies": {
        "blocked_by": [
          "phase-4"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "End-to-end integration testing and documentation updates",
        "risk_level": "low"
      }
    },
    "phase-5-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {}
    },
    "phase-5-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-5",
      "children": [
        "verify-5-1",
        "verify-5-2"
      ],
      "total_tasks": 2,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-5-1": {
      "type": "verify",
      "title": "End-to-end provider functionality test",
      "status": "pending",
      "parent": "phase-5-verify",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "command": "python3 -c \"from claude_skills.common.providers import resolve_provider; from claude_skills.common.providers.base import GenerationRequest; p = resolve_provider('opencode'); r = p._execute(GenerationRequest(prompt='What is 2+2?')); print(r.content)\"",
        "expected": "Provider instantiates, executes request, returns valid response with text content and token usage"
      },
      "dependencies": {
        "blocks": [
          "verify-5-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-5-2": {
      "type": "verify",
      "title": "Complete spec implementation fidelity review",
      "status": "pending",
      "parent": "phase-5-verify",
      "children": [],
      "dependencies": {
        "blocked_by": [
          "verify-5-1"
        ],
        "blocks": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "fidelity",
        "skill": "sdd-fidelity-review",
        "scope": "spec",
        "target": "spec-root",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "agent": "sdd-fidelity-review"
      }
    },
    "task-1-5": {
      "type": "task",
      "title": "Environment variable handling in wrapper",
      "description": "Add support for passing configuration via environment variables to the Node.js wrapper. The wrapper must read: OPENCODE_API_KEY (optional, if required for OpenCode server access), OPENCODE_SERVER_URL (optional, with default), and any other SDK configuration from environment. Document expected environment variables in wrapper code comments.",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "estimated_hours": 1,
        "file_path": "task-1-5.md",
        "task_category": "implementation",
        "description": "Enable configuration passing from Python to Node.js via environment"
      },
      "dependencies": {
        "blocks": [
          "task-2-1",
          "task-2-3"
        ],
        "blocked_by": [
          "task-1-1"
        ],
        "depends": []
      }
    },
    "task-2-3": {
      "type": "task",
      "title": "Pass environment variables to subprocess",
      "description": "Update OpenCodeProvider to pass required environment variables to the Node.js subprocess. Use subprocess env parameter to pass: OPENCODE_API_KEY from config/environment, OPENCODE_SERVER_URL if configured, and inherit other necessary env vars. Ensure sensitive data (API keys) are handled securely.",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "estimated_hours": 1,
        "file_path": "task-2-3.md",
        "task_category": "implementation",
        "description": "Security: Secure handling of API keys in subprocess environment"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-2-1",
          "task-1-5"
        ],
        "depends": []
      }
    },
    "task-5-1": {
      "type": "task",
      "title": "Create OpenCode provider documentation",
      "description": "Create comprehensive documentation for the OpenCode provider. Document: (1) Prerequisites - Node.js >= 16.x required, (2) Configuration - OPENCODE_API_KEY and OPENCODE_SERVER_URL environment variables, (3) Installation - how to enable in ai_config.yaml, (4) Usage examples, (5) Troubleshooting common issues. Add to docs/providers/OPENCODE.md or update existing AI_CONTEXT.md.",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "estimated_hours": 2,
        "file_path": "task-5-1.md",
        "task_category": "implementation",
        "description": "Must document Node.js prerequisite and environment configuration"
      },
      "dependencies": {
        "blocks": [
          "task-5-2"
        ],
        "blocked_by": [
          "task-4-1"
        ],
        "depends": []
      }
    },
    "verify-1-1-4-1": {
      "type": "verify",
      "title": "Verify wrapper outputs line-delimited JSON chunks, not single blob",
      "description": "Verify wrapper outputs line-delimited JSON chunks, not single blob",
      "status": "pending",
      "parent": "task-1-1-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "command": "",
        "expected": ""
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-2-1-4-1": {
      "type": "verify",
      "title": "Verify subprocess uses list-format arguments (no shell injection vulnerability)",
      "description": "Verify subprocess uses list-format arguments (no shell injection vulnerability)",
      "status": "pending",
      "parent": "task-2-1-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "command": "",
        "expected": ""
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-3-2-1-1": {
      "type": "verify",
      "title": "Verify detector checks for 'node' runtime, not 'opencode' binary",
      "description": "Verify detector checks for 'node' runtime, not 'opencode' binary",
      "status": "pending",
      "parent": "task-3-2-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "command": "",
        "expected": ""
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-5-2": {
      "type": "task",
      "title": "Create provider setup command/documentation",
      "description": "Add user-facing setup instructions for OpenCode provider. Update documentation to explain that after installing the Python package, users must run 'cd [install_path]/providers/opencode && npm install' to hydrate Node.js dependencies. Consider adding a convenience command 'sdd setup-provider opencode' that automates this step. Document this requirement prominently in installation instructions and troubleshooting guide.",
      "status": "pending",
      "parent": "phase-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "estimated_hours": 2,
        "file_path": "docs/providers/OPENCODE.md",
        "task_category": "implementation",
        "description": "Critical for end-user experience. Must explain node_modules setup clearly."
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-5-1"
        ],
        "depends": []
      }
    },
    "verify-1-1-1-2": {
      "type": "verify",
      "title": "Verify wrapper reads from stdin, not argv (no prompt in args)",
      "description": "Verify wrapper reads from stdin, not argv (no prompt in args)",
      "status": "pending",
      "parent": "task-1-1-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "command": "",
        "expected": ""
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-1-1-4-2": {
      "type": "verify",
      "title": "Verify errors output structured JSON {type: 'error', ...}, not stack traces",
      "description": "Verify errors output structured JSON {type: 'error', ...}, not stack traces",
      "status": "pending",
      "parent": "task-1-1-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "command": "",
        "expected": ""
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-2-1-5-1": {
      "type": "verify",
      "title": "Verify availability check detects missing node_modules and provides setup instructions",
      "description": "Verify availability check detects missing node_modules and provides setup instructions",
      "status": "pending",
      "parent": "task-2-1-5",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "command": "",
        "expected": ""
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    }
  },
  "journal": [
    {
      "timestamp": "2025-11-19T00:36:43.265023Z",
      "entry_type": "note",
      "title": "Applied Plan Review Feedback",
      "author": "claude-code",
      "content": "Applied 9 modifications based on full plan review findings:\n\nCRITICAL FIXES:\n1. Updated task-1-1-4: Node.js wrapper now implements line-delimited JSON streaming instead of single blob output\n2. Updated task-2-1-4: Python provider now handles streaming chunks + uses list-format subprocess args to prevent shell injection\n3. Updated task-3-2-1: Detector now checks for 'node' runtime instead of non-existent 'opencode' binary\n\nNEW TASKS ADDED:\n4. task-1-5: Environment variable handling in wrapper (API keys, server URL)\n5. task-2-3: Pass environment variables from Python to Node.js subprocess\n6. task-5-1: Create comprehensive OpenCode provider documentation\n\nVERIFICATION STEPS:\n- Added 3 new verification steps to validate streaming, security, and detection fixes\n\nAll critical blockers from review have been addressed. Spec ready for implementation.",
      "metadata": {}
    },
    {
      "timestamp": "2025-11-19T00:44:53.695101Z",
      "entry_type": "note",
      "title": "Applied Second Review Improvements",
      "author": "claude-code",
      "content": "Applied 11 modifications based on second review feedback:\n\nMAJOR IMPROVEMENTS:\n1. Stdin-based communication (task-1-1-1, task-1-1-3, task-2-1-4):\n   - Refactored to pass JSON payload via stdin instead of CLI args\n   - Avoids OS argument length limits (~128KB)\n   - Supports arbitrarily large prompts and complex tool schemas\n\n2. Structured error propagation (task-1-1-4):\n   - Added top-level try/catch wrapper in Node.js\n   - All errors output structured JSON: {type: 'error', code: '...', message: '...'}\n   - Prevents stack traces from breaking Python JSON parsing\n   - Enables meaningful error messages to users\n\n3. User-facing dependency management (task-2-1-5, task-5-2):\n   - Updated availability check to detect missing node_modules\n   - Provides specific setup instructions when dependencies missing\n   - Added task-5-2 for setup command/documentation\n\nADDITIONAL ENHANCEMENTS:\n4. Pinned SDK version (task-1-2-1): Prevents breakage from future updates\n5. Graceful shutdown (task-1-1-2): SIGINT/SIGTERM handlers for clean termination\n6. Added 3 new verification steps for stdin, error handling, and dependency checks\n\nValidation: \u2705 0 errors, 0 warnings\nSpec is production-ready with robust error handling and user experience improvements.",
      "metadata": {}
    },
    {
      "timestamp": "2025-11-19T01:25:00.000000Z",
      "entry_type": "note",
      "title": "Added Server Lifecycle Management",
      "author": "claude-code",
      "content": "Updated spec to address server process management:\n\n1. Server Management (Task 2-1-7): Added explicit task for Python provider to manage 'opencode serve' process. This ensures a server is running without per-request startup overhead.\n2. Client Connection (Task 1-1-2): Updated wrapper to use 'createOpencodeClient()' to connect to the managed server instead of starting its own.\n3. Availability Checks (Task 2-1-5, 3-2-1): Updated checks to verify 'opencode' binary availability for server spawning.\n\nArchitecture: Python Provider manages Server Process -> Node.js Wrapper connects as Client.",
      "metadata": {}
    },
    {
      "timestamp": "2025-11-19T01:45:00.000000Z",
      "entry_type": "note",
      "title": "Added Session Creation Step",
      "author": "gemini-cli",
      "content": "Updated Task 1-1-3 to explicitly include creating a session via `client.session.create()` before executing a prompt. This aligns with the OpenCode SDK requirements where `prompt` requires a valid `session.id`.",
      "metadata": {}
    },
    {
      "timestamp": "2025-11-19T12:29:51.580885Z",
      "entry_type": "status_change",
      "title": "Task Completed: Create package.json with OpenCode SDK dependency",
      "author": "claude-code",
      "content": "Created package.json in src/providers/opencode/ with pinned @opencode-ai/sdk version ^1.0.0. Configured type: module for ES6 imports. Added engines field to enforce Node.js >= 16.0.0. Includes all required fields: name, version, description, main entry point (opencode_wrapper.js). File location: /home/tyler/Documents/GitHub/claude-sdd-toolkit/src/providers/opencode/package.json",
      "metadata": {},
      "task_id": "task-1-2-1"
    }
  ],
  "metadata": {
    "status": "active",
    "activated_date": "2025-11-19T12:27:21.771722Z",
    "progress_percentage": 2,
    "current_phase": "phase-1"
  }
}