{
  "spec_id": "provider-abstraction-refactor-2025-11-10-001",
  "title": "Provider Abstraction Refactor",
  "generated": "2025-11-10T15:00:00Z",
  "last_updated": "2025-11-11T17:51:09.001660Z",
  "metadata": {
    "title": "Provider Abstraction Refactor",
    "description": "Refactor AI tool orchestration to use a provider abstraction inspired by model_chorus patterns, enabling consistent onboarding of new tools and cleaner runtime integration.",
    "objectives": [
      "Create a shared provider abstraction layer with clear contracts for tool orchestration.",
      "Introduce provider-specific implementations for Gemini, Codex, and Cursor Agent aligned with the new base module.",
      "Update ai_tools, configuration modules, and runtimes to consume the provider abstraction without regressions.",
      "Expand unit and integration test coverage to ensure reliability across supported providers."
    ],
    "complexity": "high",
    "estimated_hours": 59,
    "assumptions": [
      "Existing model_chorus provider patterns remain representative of desired orchestration behaviours.",
      "Provider credential management and secrets handling are already established and do not require redesign.",
      "Runtime consumers (run-tests and SDD skills) can adopt the provider registry without breaking existing CLI contracts."
    ],
    "status": "active",
    "activated_date": "2025-11-11T17:24:32.862704Z",
    "progress_percentage": 30,
    "current_phase": "phase-2"
  },
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "Provider Abstraction Refactor",
      "status": "in_progress",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3",
        "phase-4"
      ],
      "total_tasks": 20,
      "completed_tasks": 6,
      "metadata": {
        "purpose": "Deliver a modular provider abstraction that consolidates tool orchestration logic across the toolkit.",
        "estimated_hours": 59,
        "complexity": "high"
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "Design Foundations",
      "status": "completed",
      "parent": "spec-root",
      "children": [
        "task-1-1",
        "task-1-2",
        "task-1-3",
        "verify-1-1"
      ],
      "total_tasks": 4,
      "completed_tasks": 4,
      "metadata": {
        "purpose": "Document current provider usage and produce the blueprint for the new abstraction.",
        "estimated_hours": 11,
        "owner": "architecture",
        "needs_journaling": false,
        "completed_at": "2025-11-11T17:42:55.955115Z",
        "journaled_at": "2025-11-11T17:42:55.966294Z"
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "Audit existing model_chorus provider flows",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "investigation",
        "estimated_hours": 4,
        "file_path": "docs/research/model_chorus_provider_audit.md",
        "details": "Catalog responsibilities, entrypoints, and data contracts from model_chorus provider implementations to inform abstraction boundaries.",
        "started_at": "2025-11-11T17:30:18.630115Z",
        "status_note": "Auditing provider flows and drafting doc.",
        "completed_at": "2025-11-11T17:30:22.175759Z",
        "needs_journaling": false,
        "actual_hours": 0.001,
        "journaled_at": "2025-11-11T17:30:22.184885Z"
      }
    },
    "task-1-2": {
      "type": "task",
      "title": "Map abstraction requirements to consumer expectations",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "research",
        "estimated_hours": 3,
        "file_path": "docs/research/provider_requirements_matrix.md",
        "details": "Align new provider capabilities with needs from run-tests, sdd skills, and CLI tooling including error handling and streaming behaviour.",
        "started_at": "2025-11-11T17:36:26.939233Z",
        "status_note": "Mapping consumer requirements for provider abstraction.",
        "completed_at": "2025-11-11T17:36:31.432885Z",
        "needs_journaling": false,
        "actual_hours": 0.001,
        "journaled_at": "2025-11-11T17:36:31.437065Z"
      }
    },
    "task-1-3": {
      "type": "task",
      "title": "Draft provider abstraction architecture blueprint",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "decision",
        "estimated_hours": 4,
        "file_path": "docs/ARCHITECTURE.md",
        "details": "Produce UML-style diagrams and interface definitions covering base provider contracts, registry interaction, and lifecycle hooks.",
        "started_at": "2025-11-11T17:40:17.197510Z",
        "status_note": "Drafting provider abstraction blueprint in architecture doc.",
        "completed_at": "2025-11-11T17:40:26.041261Z",
        "needs_journaling": false,
        "actual_hours": 0.002,
        "journaled_at": "2025-11-11T17:40:26.044298Z"
      }
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Blueprint review sign-off",
      "status": "completed",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "verification_type": "manual",
        "owner": "architecture",
        "expected": "Design review approved with sign-off from architecture lead and implementation stakeholders.",
        "completed_at": "2025-11-11T17:42:55.955061Z",
        "needs_journaling": false,
        "journaled_at": "2025-11-11T17:42:55.957817Z"
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Scaffolding & Core Modules",
      "status": "in_progress",
      "parent": "spec-root",
      "children": [
        "task-2-1",
        "task-2-2",
        "task-2-3",
        "task-2-4",
        "verify-2-1"
      ],
      "total_tasks": 5,
      "completed_tasks": 2,
      "metadata": {
        "purpose": "Introduce the foundational provider abstraction modules and supporting scaffolding.",
        "estimated_hours": 16,
        "owner": "core-platform"
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "Implement base provider module",
      "status": "completed",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 5,
        "file_path": "src/claude_skills/claude_skills/common/providers/base.py",
        "changes": "Define ProviderContext, abstract execution hooks, and error surface for compliant providers.",
        "started_at": "2025-11-11T17:46:11.330633Z",
        "status_note": "Adding provider base abstractions.",
        "completed_at": "2025-11-11T17:46:20.996909Z",
        "needs_journaling": false,
        "actual_hours": 0.003,
        "journaled_at": "2025-11-11T17:46:21.006058Z"
      }
    },
    "task-2-2": {
      "type": "task",
      "title": "Create CLI orchestration layer",
      "status": "completed",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 4,
        "file_path": "src/claude_skills/claude_skills/cli/provider_runner.py",
        "changes": "Expose command-line entrypoints to run providers with consistent logging, timeouts, and output formatting.",
        "completed_at": "2025-11-11T17:51:08.992002Z",
        "needs_journaling": false,
        "journaled_at": "2025-11-11T17:51:08.993917Z"
      }
    },
    "task-2-3": {
      "type": "task",
      "title": "Add provider registry utilities",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 4,
        "file_path": "src/claude_skills/claude_skills/common/providers/registry.py",
        "changes": "Implement lazy registration, discovery, and dependency injection hooks for provider instances."
      }
    },
    "task-2-4": {
      "type": "task",
      "title": "Write foundational unit tests",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 3,
        "file_path": "tests/providers/test_base_provider.py",
        "changes": "Cover base provider behaviours, registry resolution pathways, and CLI orchestration happy paths."
      }
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Unit test coverage baseline",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "command": "pytest tests/providers -q",
        "expected": "All foundational provider unit tests pass with minimum 80% coverage on new modules.",
        "owner": "qa"
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Tool Provider Integrations",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-3-1",
        "task-3-2",
        "task-3-3",
        "task-3-4",
        "task-3-5",
        "verify-3-1"
      ],
      "total_tasks": 6,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Port key tool integrations to the new abstraction for parity with existing capabilities.",
        "estimated_hours": 19,
        "owner": "integrations"
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "Implement Gemini provider",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 4,
        "file_path": "src/claude_skills/claude_skills/common/providers/gemini.py",
        "changes": "Adapt Gemini-specific command execution, auth, and response shaping to ProviderContext contract."
      }
    },
    "task-3-2": {
      "type": "task",
      "title": "Implement Codex provider",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 4,
        "file_path": "src/claude_skills/claude_skills/common/providers/codex.py",
        "changes": "Wrap Codex invocation semantics and error handling in the provider abstraction."
      }
    },
    "task-3-3": {
      "type": "task",
      "title": "Implement Cursor Agent provider",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 4,
        "file_path": "src/claude_skills/claude_skills/common/providers/cursor_agent.py",
        "changes": "Bridge Cursor Agent workflows through the provider interface, including streaming output normalisation."
      }
    },
    "task-3-4": {
      "type": "task",
      "title": "Add provider availability detection",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 3,
        "file_path": "src/claude_skills/claude_skills/common/providers/detectors.py",
        "changes": "Centralise provider discovery strategies including environment checks and feature flags."
      }
    },
    "task-3-5": {
      "type": "task",
      "title": "Author integration tests for provider orchestration",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 4,
        "file_path": "tests/providers/test_integration.py",
        "changes": "Ensure multi-provider execution scenarios cover fallbacks, parallelism, and failure modes."
      }
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Integration suite passes for providers",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "command": "pytest tests/providers -k integration -q",
        "expected": "Gemini, Codex, and Cursor Agent providers pass orchestration integration suite.",
        "owner": "qa"
      }
    },
    "phase-4": {
      "type": "phase",
      "title": "Refactor & Rollout",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-4-1",
        "task-4-2",
        "task-4-3",
        "task-4-4",
        "verify-4-1"
      ],
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Adopt the provider abstraction across runtime surfaces and documentation.",
        "estimated_hours": 13,
        "owner": "core-platform"
      }
    },
    "task-4-1": {
      "type": "task",
      "title": "Refactor ai_tools to delegate to providers",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "refactoring",
        "estimated_hours": 4,
        "file_path": "src/claude_skills/claude_skills/common/ai_tools.py",
        "changes": "Replace direct tool orchestration logic with provider registry lookups and normalized execution flow."
      }
    },
    "task-4-2": {
      "type": "task",
      "title": "Update configuration modules for providers",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 3,
        "file_path": "src/claude_skills/claude_skills/common/ai_config.py",
        "changes": "Introduce provider-centric configuration knobs, default fallbacks, and compatibility shims."
      }
    },
    "task-4-3": {
      "type": "task",
      "title": "Align runtime consumers with provider registry",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "refactoring",
        "estimated_hours": 4,
        "file_path": "src/claude_skills/claude_skills",
        "details": "Update run-tests and SDD skill runtimes to resolve providers via registry and handle new response envelopes."
      }
    },
    "task-4-4": {
      "type": "task",
      "title": "Revise documentation and changelog",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation",
        "estimated_hours": 2,
        "file_path": "docs/DOCUMENTATION.md",
        "changes": "Document provider abstraction usage, update README sections, and note changes in CHANGELOG."
      }
    },
    "verify-4-1": {
      "type": "verify",
      "title": "End-to-end regression run",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "command": "sdd run-tests all",
        "expected": "Regression suite passes with provider abstraction enabled and no CLI regressions.",
        "owner": "release"
      }
    }
  },
  "journal": [
    {
      "timestamp": "2025-11-11T17:30:22.184864Z",
      "entry_type": "status_change",
      "title": "Provider audit",
      "author": "claude-code",
      "content": "Created docs/research/model_chorus_provider_audit.md summarizing ModelChorus base interfaces, CLI scaffolding, and concrete providers (Claude, Gemini, Codex, Cursor Agent). Captured responsibilities, entrypoints, JSON contracts, security constraints, and noted Gemini supports_thinking bug for the refactor.\n\nVerification: manual review of new doc and source files.",
      "metadata": {},
      "task_id": "task-1-1"
    },
    {
      "timestamp": "2025-11-11T17:36:31.437027Z",
      "entry_type": "status_change",
      "title": "Provider requirement matrix",
      "author": "claude-code",
      "content": "Authored docs/research/provider_requirements_matrix.md capturing run-tests, sdd-fidelity-review, and sdd-plan-review consumer expectations plus shared CLI tooling requirements. Documented tool routing, prompt packaging, streaming, error handling, caching, and security constraints, and highlighted gaps + next steps for ProviderContext design.\n\nVerification: manual doc review.",
      "metadata": {},
      "task_id": "task-1-2"
    },
    {
      "timestamp": "2025-11-11T17:40:26.044282Z",
      "entry_type": "status_change",
      "title": "Provider abstraction blueprint",
      "author": "claude-code",
      "content": "Expanded docs/ARCHITECTURE.md with Section 7 detailing the provider abstraction blueprint: goals, registry + provider interfaces (Mermaid diagram), lifecycle hooks, integration notes for run-tests/fidelity-review/plan-review, and extension hooks for streaming and telemetry.\n\nVerification: manual review of architecture doc.",
      "metadata": {},
      "task_id": "task-1-3"
    },
    {
      "timestamp": "2025-11-11T17:42:55.957796Z",
      "entry_type": "status_change",
      "title": "Blueprint sign-off",
      "author": "claude-code",
      "content": "Architecture lead approved the provider abstraction blueprint in docs/ARCHITECTURE.md (with optional streaming support retained). Verification done via conversation confirmation.",
      "metadata": {},
      "task_id": "verify-1-1"
    },
    {
      "timestamp": "2025-11-11T17:42:55.966280Z",
      "entry_type": "status_change",
      "title": "Phase Completed: Design Foundations",
      "author": "claude-code",
      "content": "All child tasks in phase phase-1 have been completed.",
      "metadata": {},
      "task_id": "phase-1"
    },
    {
      "timestamp": "2025-11-11T17:46:21.006038Z",
      "entry_type": "status_change",
      "title": "Base provider module",
      "author": "claude-code",
      "content": "Implemented src/claude_skills/claude_skills/common/providers/base.py plus package exports. Defines ProviderCapability/Status enums, token/model metadata dataclasses, GenerationRequest/Result/StreamChunk, lifecycle hooks, and ProviderContext abstraction with standardized error handling and streaming hooks.\n\nVerification: manual review.",
      "metadata": {},
      "task_id": "task-2-1"
    },
    {
      "timestamp": "2025-11-11T17:51:08.993902Z",
      "entry_type": "status_change",
      "title": "CLI provider runner",
      "author": "claude-code",
      "content": "Added src/claude_skills/claude_skills/cli/provider_runner.py exposing build_parser/run_cli/run_provider helpers. Runner parses prompts/metadata, invokes ProviderContext via hooks, handles streaming output buffering, pretty/JSON formatting, and standardized error handling for missing providers, timeouts, and execution failures.\n\nVerification: python -m py_compile src/claude_skills/claude_skills/cli/provider_runner.py",
      "metadata": {},
      "task_id": "task-2-2"
    }
  ]
}